<html>
  <head>
    <!--<script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>-->
    <script src="https://binzume.github.io/aframe/dist/aframe-master.min.js"></script>
    <script src="https://unpkg.com/aframe-xylayout@0.0.1/dist/xylayout-all.js"></script>
    <script src="dist/xrhtml.js"></script>
    <script src="xrhtml.aframe.js"></script>
    <script>
        const XRHTML = xrhtml.XRHTML
        let parsers = {

          "html2canvas":{
            parser: (dom, opts, addObject ) => {
              console.log("XHTML.parser(..)")
              dom.mesh = new xrhtml.HTMLMesh( dom, opts, xrhtml.html2canvas(dom) )
              addObject(dom.mesh)
            }, 
            update: (dom) => {
              console.log("XRHTML.update(..)")
              dom.mesh.image = xrhtml.html2canvas(dom)
              dom.mesh.needsUpdate = true;
              dom.mesh.scheduleUpdate = null;
            }
          }, 

          xylayout:{

            parser: (dom, opts, addObject ) => {

              const nodes = {
                "H1": (node, parent, forceTag) => {
                  let el = nodes.dom2xylayout(node, parent, "text")
                  el.setAttribute("value", node.innerText )
                  return el
                }, 
                "LI": (node, parent, forceTag) => {
                  let el = nodes.dom2xylayout(node, parent, "plane")
                  el.setAttribute("value", node.innerText )
                  el.setAttribute("xyrect",{})
                  el.setAttribute("xylabel",`value: foo bar`)
                  return el
                }, 
                "OL" : (node,  parent,  forceTag) => nodes.dom2xylayout(node, parent ), 
                "UL" : (node,  parent,  forceTag) => nodes.dom2xylayout(node, parent ), 
                "DIV": (node,  parent,  forceTag) => nodes.dom2xylayout(node, parent ), 

                "dom2xylayout": (node, parent, forceTag) => { 
                  if( !node.getAttributeNames ) return // skip nontags
                  let tagName = forceTag || String(node.className).split(" ").find( (c) => c.substr(0,2) == "xy" ? c : undefined )
                  if( !tagName ) tagName = 'entity' 
                  let el = document.createElement(`a-${tagName}`)
                  let ignoreAttr = ['style']
                  // copy attributes
                  for ( var i in node.attributes ) 
                    if( node.attributes[i].nodeName && !~ignoreAttr.indexOf(node.attributes[i].nodeName) )
                      el.setAttribute( node.attributes[i].nodeName,  node.attributes[i].nodeValue )
                  if( parent ) parent.appendChild(el)
                  return el
                }         
              }
              const classToXYLayout = (className) => String(className)
                                                     .split(" ")
                                                     .map( (c) => c.substr(0,2) == "xy" )

              function walkDOM(node, parent) {
                  let nodeFunc = nodes[node.tagName] || nodes.dom2xylayout
                  console.dir({tagName:node.tagName, nodeFunc})
                  if( !nodeFunc ) return parent
                  let newparent = nodeFunc(node, parent) || parent;
                  node = node.firstChild;
                  while (node) {
                      walkDOM(node, newparent);
                      node = node.nextSibling;
                  }
                  return newparent
              }
              let aEntity = walkDOM(dom)
              console.log( aEntity.outerHTML )
              document.querySelector("a-scene").appendChild(aEntity)
            }, 

            update: (dom) => {

            }
          }
        }

        let parser = "xylayout" //"html2canvas"
        XRHTML.parser = parsers[parser].parser
        XRHTML.update = parsers[parser].update 
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity position="0 1.6 -0.6" id="afoo" xrhtml="name: foo" style="display:none">       <!-- see properties -->
        <div style="overflow:hidden" class="xywindow" position="0 0 -1" width="4" height="5" title="hello world">
            <!--
          <div class="xyscroll" width=4 height=5>
            <ol xylist="">
              <li width="4" height="1">one</li>
              <li width="4" height="1">two</li>
              <li width="4" height="1">three</li>
            </ol>
          </div>
            -->
        </div>
      </a-entity>
      <a-box position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
      <a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
      <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder>
      <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>
  </body>
</html>
